#!/bin/bash
#------------------------------------------------------------------------------
# written by: Lawrence McDaniel
#             https://lawrencemcdaniel.com
#
# date:       aug-2022
#
# usage:      initialize lms Django settings.
#             - create a user account in lms
#             - create an oauth application in lms for authentication
#------------------------------------------------------------------------------

dockerize -wait tcp://{{ MYSQL_HOST }}:{{ MYSQL_PORT }} -timeout 20s

# Enterprise service worker configuration
ENTERPRISE_WORKER_USERNAME="{{ ENTERPRISE_SERVICE_WORKER_USERNAME | default('enterprise_worker', true) }}"
ENTERPRISE_WORKER_EMAIL="${ENTERPRISE_WORKER_USERNAME}@openedx"

# Ensure the enterprise service worker account exists with a predictable email
echo "license-manager lms init: syncing enterprise worker user email"
./manage.py lms shell <<PY
from django.contrib.auth import get_user_model
User = get_user_model()
user = User.objects.filter(username='${ENTERPRISE_WORKER_USERNAME}').first()
target_email='${ENTERPRISE_WORKER_EMAIL}'
if user and user.email != target_email:
    user.email = target_email
    user.save()
PY

echo "license-manager lms init: ensuring enterprise service worker user exists"
./manage.py lms manage_user ${ENTERPRISE_WORKER_USERNAME} ${ENTERPRISE_WORKER_EMAIL} --staff --superuser --unusable-password

echo "license-manager lms init: configuring ENTERPRISE_SERVICE_WORKER_USERNAME"
./manage.py lms shell <<PY
from django.contrib.sites.models import Site
try:
    from openedx.core.djangoapps.site_configuration.models import SiteConfiguration
except ImportError:
    SiteConfiguration = None

if SiteConfiguration:
    site = Site.objects.get_current()
    site_config, _ = SiteConfiguration.objects.get_or_create(site=site)
    values = dict(site_config.site_values or {})
    override = '${ENTERPRISE_WORKER_USERNAME}'
    if values.get('ENTERPRISE_SERVICE_WORKER_USERNAME') != override:
        values['ENTERPRISE_SERVICE_WORKER_USERNAME'] = override
        site_config.site_values = values
        site_config.save()
else:
    print('SiteConfiguration unavailable; skipping ENTERPRISE_SERVICE_WORKER_USERNAME override')
PY

# Modify users created with an incorrect email and that might clash with the newly created users
./manage.py lms shell <<'PY'
from django.contrib.auth import get_user_model
User = get_user_model()
User.objects.filter(username='license_manager').exclude(email='license_manager@openedx').update(email='license_manager@openedx')
PY

./manage.py lms manage_user license_manager license_manager@openedx --staff --superuser --unusable-password

# Development client
./manage.py lms create_dot_application \
    --grant-type client-credentials \
    --redirect-uris "http://{{ LICENSE_MANAGER_HOST }}:8000/complete/edx-oauth2/" \
    --client-id {{ LICENSE_MANAGER_OAUTH2_KEY_DEV }} \
    --client-secret {{ LICENSE_MANAGER_OAUTH2_SECRET_DEV }} \
    --scopes user_id \
    --skip-authorization \
    --update \
    license-manager-dev \
    license_manager
./manage.py lms create_dot_application \
    --grant-type authorization-code \
    --redirect-uris "http://{{ LICENSE_MANAGER_HOST }}:8000/complete/edx-oauth2/" \
    --client-id {{ LICENSE_MANAGER_OAUTH2_KEY_SSO_DEV }} \
    --client-secret {{ LICENSE_MANAGER_OAUTH2_SECRET_SSO_DEV }} \
    --scopes user_id \
    --skip-authorization \
    --update \
    license-manager-sso-dev \
    license_manager

# Production client
./manage.py lms create_dot_application \
  --grant-type client-credentials \
  --redirect-uris "{% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ LICENSE_MANAGER_HOST }}/complete/edx-oauth2/" \
  --client-id {{ LICENSE_MANAGER_OAUTH2_KEY }} \
  --client-secret {{ LICENSE_MANAGER_OAUTH2_SECRET }} \
  --scopes user_id \
  --skip-authorization \
  --update \
  license_manager \
  license_manager
./manage.py lms create_dot_application \
  --grant-type authorization-code \
  --redirect-uris "{% if ENABLE_HTTPS %}https{% else %}http{% endif %}://{{ LICENSE_MANAGER_HOST }}/complete/edx-oauth2/" \
  --client-id {{ LICENSE_MANAGER_OAUTH2_KEY_SSO }} \
  --client-secret {{ LICENSE_MANAGER_OAUTH2_SECRET_SSO }} \
  --scopes user_id \
  --skip-authorization \
  --update \
  license-manager-sso \
  license_manager

# FIX NOTE: review this command to see what needs to be duplicated.
# Create commerce configuration
#./manage.py lms configure_commerce
