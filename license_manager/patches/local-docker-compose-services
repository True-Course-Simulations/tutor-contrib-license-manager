{% set LICENSE_MANAGER_IMAGE = LICENSE_MANAGER_DOCKER_IMAGE or LICENSE_MANAGER_BUILT_IMAGE %}
license-manager:
  image: {{ LICENSE_MANAGER_IMAGE }}
  environment:
    DJANGO_SETTINGS_MODULE: license_manager.settings.tutor.production
    SERVICE_VARIANT: license_manager
    CELERY_BROKER_TRANSPORT: redis
    CELERY_BROKER_HOSTNAME: "{{ REDIS_HOST }}:{{ REDIS_PORT }}"
    CELERY_BROKER_VHOST: "0"
    CELERY_BROKER_USER: ""
    CELERY_BROKER_PASSWORD: "{{ REDIS_PASSWORD }}"
  restart: unless-stopped
  volumes:
    - ../plugins/license_manager/apps/license_manager/settings:/openedx/license_manager/license_manager/settings/tutor:ro
  depends_on:
    {% if RUN_MYSQL %}- mysql{% endif %}
    - lms
    - redis

license-manager-worker:
  image: {{ LICENSE_MANAGER_IMAGE }}
  command: >
    /bin/bash -c "dockerize -wait tcp://{{ MYSQL_HOST }}:{{ MYSQL_PORT }} -timeout 20s &&
    celery -A license_manager worker --loglevel=info --hostname=license-manager-worker@%h
    --queues=license_manager.default,license_manager.bulk_enrollment"
  environment:
    DJANGO_SETTINGS_MODULE: license_manager.settings.tutor.production
    SERVICE_VARIANT: license_manager-worker
    CELERY_BROKER_TRANSPORT: redis
    CELERY_BROKER_HOSTNAME: "{{ REDIS_HOST }}:{{ REDIS_PORT }}"
    CELERY_BROKER_VHOST: "0"
    CELERY_BROKER_USER: ""
    CELERY_BROKER_PASSWORD: "{{ REDIS_PASSWORD }}"
  restart: unless-stopped
  volumes:
    - ../plugins/license_manager/apps/license_manager/settings:/openedx/license_manager/license_manager/settings/tutor:ro
  depends_on:
    {% if RUN_MYSQL %}- mysql{% endif %}
    - lms
    - redis
